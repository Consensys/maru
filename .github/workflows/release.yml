name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  actions: read
  id-token: write

concurrency:
  group: maru-release-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  compute-version:
    runs-on: gha-runner-scale-set-ubuntu-22.04-amd64-small
    name: Compute version
    outputs:
      tag_name: ${{ steps.version.outputs.tag_name }}
      full_version: ${{ steps.version.outputs.full_version }}
      date: ${{ steps.version.outputs.date }}
      commit_hash: ${{ steps.version.outputs.commit_hash }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag and compute version
        id: version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Tag: $TAG_NAME"

          # Validate tag format: v<semver>-<product-label-ver>?
          # Examples: v2.0.1-betav4 OR v2.0.1 OR v2.0.1-beta-v4
          if [[ ! $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9-]+)?$ ]]; then
            echo "Error: Tag format is invalid. Expected format: v<semver>-<product-label-ver>?"
            echo "Examples: v2.0.1-betav4 OR v2.0.1 OR v2.0.1-beta-v4"
            exit 1
          fi

          # Compute date and commit hash
          DATE=$(date -u +%Y%m%d%H%M%S)
          COMMIT_HASH=$(git rev-parse --short HEAD)

          # Create full version: <semver>-<product-label-ver>?-<date>-<commit-hash>
          FULL_VERSION="${TAG_NAME}-${DATE}-${COMMIT_HASH}"

          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT

          echo "Release tag: $TAG_NAME"
          echo "Full version: $FULL_VERSION"

  build-and-publish-docker:
    needs: compute-version
    uses: ./.github/workflows/maru-build-and-publish.yml
    with:
      commit_tag: ${{ needs.compute-version.outputs.full_version }}
      develop_tag: ${{ needs.compute-version.outputs.tag_name }}
      image_name: 'consensys/maru'
      push_image: true
      upload_dist_artifact: true
    secrets: inherit

  create-release:
    needs: [compute-version, build-and-publish-docker]
    runs-on: gha-runner-scale-set-ubuntu-22.04-amd64-large
    name: Create GitHub Release
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download distribution artifact
        uses: actions/download-artifact@v4
        with:
          name: maru-distribution
          path: app/build/install/app/

      - name: Create distribution archive
        run: |
          tar -czf maru-${{ needs.compute-version.outputs.full_version }}.tar.gz -C app/build/install/app .

      - name: Prepare release body
        run: |
          cat << 'EOF' > release-body.md
          ## Docker Image

          ðŸ³ **Docker Hub:** https://hub.docker.com/r/consensys/maru/tags?name=${{ needs.compute-version.outputs.full_version }}

          ```bash
          docker pull consensys/maru:${{ needs.compute-version.outputs.full_version }}
          ```

          EOF
          cat CHANGELOG.md >> release-body.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          body_path: release-body.md
          files: maru-${{ needs.compute-version.outputs.full_version }}.tar.gz
          fail_on_unmatched_files: true
          make_latest: true
